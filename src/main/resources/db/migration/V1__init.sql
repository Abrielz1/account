
CREATE TABLE IF NOT EXISTS accounts (
    id                  BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    balance             DECIMAL(19,2) CONSTRAINT balance_non_negative CHECK (balance >= 0),
    initial_balance     DECIMAL(19,2) CONSTRAINT initial_balance_non_negative CHECK (initial_balance >= 0),
    version             BIGINT DEFAULT 0,
        CONSTRAINT max_balance_limit
        CHECK (balance <= initial_balance * 2.07)
);

CREATE TABLE IF NOT EXISTS users (
     id                  BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
     username            VARCHAR(255) NOT NULL UNIQUE CHECK (length(trim(username)) >= 3 ),
     password            VARCHAR(3200) NOT NULL,
     date_of_birth       DATE NOT NULL,
     account_id          BIGINT UNIQUE NOT NULL REFERENCES accounts(id) ON DELETE CASCADE,
     version             BIGINT DEFAULT 0,
     CONSTRAINT unique_username UNIQUE (username)
);

CREATE TABLE user_roles (
    user_id             BIGINT       NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    roles               VARCHAR(255) NOT NULL CHECK (roles IN ('ROLE_USER')),
    PRIMARY KEY (user_id, roles)
);


CREATE TABLE IF NOT EXISTS email_data(
    id                  BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    email               VARCHAR(320) NOT NULL UNIQUE CHECK (email ~* '^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$'),
    user_id             BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    version             BIGINT DEFAULT 0,
        CONSTRAINT unique_email UNIQUE (email)
);

CREATE TABLE IF NOT EXISTS phone_data(
   id                  BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
   phone               VARCHAR(20) NOT NULL UNIQUE CHECK (phone ~ '^\+7\d{10}$'),
   user_id             BIGINT NOT NULL REFERENCES users(id) ON DELETE CASCADE,
   version             BIGINT DEFAULT 0
);

CREATE EXTENSION IF NOT EXISTS pg_trgm;

CREATE INDEX idx_user_roles_user_id ON user_roles(user_id);
CREATE INDEX idx_user_username ON users(username);
CREATE INDEX idx_email_data_user_id ON email_data(user_id);
CREATE INDEX idx_accounts_balance ON accounts(balance);
CREATE INDEX idx_accounts_initial_balance ON accounts(initial_balance);
CREATE INDEX idx_users_account_id ON users(account_id);
CREATE INDEX idx_users_username_trgm ON users USING GIN (LOWER(username) gin_trgm_ops);
CREATE INDEX idx_phone_data_user_id ON phone_data(user_id);
CREATE INDEX idx_email_data_email ON email_data(email);
CREATE INDEX idx_phone_data_phone ON phone_data(phone);

SET lock_timeout = '5s';

COMMENT ON CONSTRAINT max_balance_limit
ON accounts IS 'Баланс не может превышать 207% от начального депозита';


INSERT INTO accounts(id, balance, initial_balance)
VALUES (1, 10.0, 10.0),
       (2, 10.0, 10.0),
       (3, 10.0, 10.0),
       (4, 10.0, 10.0),
       (5, 10.0, 10.0),
       (6, 10.0, 10.0),
       (7, 10.0, 10.0);

INSERT INTO users(id, username, password, date_of_birth, account_id)
VALUES (
           1,
           'john_shepard',
           '$2a$12$q4fb3xtW/X.dSh2jSUr88exA52T05hTJzEyo/vb9gRkWqxUrQopH2',
           '2006-06-06',
           1
       ),
       (2, 'vlastimil_peterjela', '$2a$04$gHdOJO0XG6NdKZoDceWgoeu8FtP0IoOScxeaxS3zWOb1.hyPOw8gK','2007-07-07', 2),
       (3, 'hacku_yuki', '$2a$04$gHdOJO0XG6NdKZoDceWgoeu8FtP0IoOScxeaxS3zWOb1.hyPOw8gK', '2008-06-06', 3),
       (4, 'tarja_turunen', '$2a$04$gHdOJO0XG6NdKZoDceWgoeu8FtP0IoOScxeaxS3zWOb1.hyPOw8gK', '1970-07-01', 4),
       (5, 'nathatan_drake', '$2a$04$gHdOJO0XG6NdKZoDceWgoeu8FtP0IoOScxeaxS3zWOb1.hyPOw8gK', '1980-11-11', 5),
       (6, 'nate_pinkerthon', '$2a$04$gHdOJO0XG6NdKZoDceWgoeu8FtP0IoOScxeaxS3zWOb1.hyPOw8gK', '1920-12-01', 6),
       (7, 'shion_uzuki', '$2a$04$gHdOJO0XG6NdKZoDceWgoeu8FtP0IoOScxeaxS3zWOb1.hyPOw8gK', '1999-10-10', 7);

INSERT INTO user_roles
(user_id, roles)
VALUES (1, 'ROLE_USER'),
       (2, 'ROLE_USER'),
       (3, 'ROLE_USER'),
       (4, 'ROLE_USER'),
       (5, 'ROLE_USER'),
       (6, 'ROLE_USER'),
       (7, 'ROLE_USER');


INSERT INTO email_data(id, email, user_id)
VALUES (1, 'john_shepard@gmail.com', 1),
       (2, 'vlastimil@gmail.com', 2),
       (3, 'hacku_yuki@gmail.com', 3),
       (4, 'tarja@gmail.com', 4),
       (5, 'nathatan@gmail.com', 5),
       (6, 'nate@gmail.com', 6),
       (7, 'shion@gmail.com', 7);

INSERT INTO phone_data(id, phone, user_id)
VALUES (1, '+79525559801', 1),
       (2, '+79525559802', 2),
       (3, '+79525559803', 3),
       (4, '+79525559899', 4),
       (5, '+79525559888', 5),
       (6, '+79525559807', 6),
       (7, '+79525550001', 7);


SELECT setval(
               'users_id_seq',
               (SELECT MAX(id) FROM users)
           );

SELECT setval(
               'accounts_id_seq',
               (SELECT MAX(id) FROM accounts)
           );

SELECT setval(
               'email_data_id_seq',
               (SELECT MAX(id) FROM email_data)
           );

SELECT setval(
               'phone_data_id_seq',
               (SELECT MAX(id) FROM phone_data)
           );